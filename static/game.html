<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monopoly - Game</title>
    <style>
        body {
            font-family: monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 2rem;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        h1 {
            color: #4ec9b0;
            margin: 0;
        }
        button {
            padding: 0.5rem 1rem;
            background-color: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover:not(:disabled) {
            background-color: #1177bb;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        button.back {
            background-color: #555;
        }
        button.back:hover {
            background-color: #666;
        }
        .game-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1rem;
        }
        .panel {
            background-color: #2d2d30;
            padding: 1.5rem;
            border-radius: 8px;
        }
        .player-item {
            background-color: #3c3c3c;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-item.current-turn {
            border: 2px solid #4ec9b0;
        }
        .ready-badge {
            background-color: #4ec9b0;
            color: #1e1e1e;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .not-ready {
            color: #858585;
        }
        .game-log {
            height: 300px;
            overflow-y: auto;
            background-color: #1e1e1e;
            padding: 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .log-entry {
            margin: 0.25rem 0;
            padding: 0.25rem 0;
            border-bottom: 1px solid #3c3c3c;
        }
        .log-entry.system {
            color: #4ec9b0;
        }
        .log-entry.event {
            color: #ce9178;
        }
        .controls {
            margin-top: 1rem;
        }
        .status {
            color: #858585;
            margin: 1rem 0;
        }
        .game-status {
            background-color: #3c3c3c;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Game <span id="gameId"></span></h1>
        <button class="back" onclick="window.location.href='/lobby.html'">Back to Lobby</button>
    </div>

    <div class="game-container">
        <div class="panel">
            <h2>Players</h2>
            <div id="playersList"></div>
            <div class="controls">
                <button id="readyBtn" onclick="toggleReady()">Ready</button>
            </div>
        </div>

        <div class="panel">
            <div class="game-status">
                <div>Status: <span id="gameStatus"></span></div>
                <div id="currentTurn"></div>
            </div>

            <div class="controls">
                <button id="endTurnBtn" onclick="endTurn()" disabled>End Turn</button>
            </div>

            <h3>Game Log</h3>
            <div class="game-log" id="gameLog"></div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = parseInt(urlParams.get('gameId'));
        const userId = parseInt(localStorage.getItem('userId'));
        const username = localStorage.getItem('username');

        if (!gameId || !userId || !username) {
            window.location.href = '/';
        }

        document.getElementById('gameId').textContent = gameId;

        let ws;
        let isReady = false;
        let gameState = null;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/game/${gameId}`);

            ws.onopen = () => {
                addLog('Connected to game', 'system');
                loadGameState();
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };

            ws.onerror = (error) => {
                addLog('WebSocket error', 'system');
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                addLog('Disconnected from game', 'system');
                setTimeout(connectWebSocket, 3000);
            };
        }

        async function loadGameState() {
            try {
                const response = await fetch(`/api/lobby/games/${gameId}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    gameState = await response.json();
                    updateUI();
                }
            } catch (err) {
                console.error('Failed to load game state:', err);
            }
        }

        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'player_joined':
                    addLog(`${message.payload.player.username} joined the game`, 'event');
                    loadGameState();
                    break;

                case 'player_ready':
                    addLog(`Player ready status updated`, 'event');
                    loadGameState();
                    break;

                case 'game_started':
                    addLog('Game started!', 'event');
                    loadGameState();
                    break;

                case 'turn_changed':
                    addLog('Turn changed', 'event');
                    loadGameState();
                    break;

                case 'error':
                    addLog(`Error: ${message.payload.message}`, 'system');
                    break;
            }
        }

        function updateUI() {
            if (!gameState) return;

            // Update game status
            document.getElementById('gameStatus').textContent = gameState.status;

            // Update players list
            const playersListDiv = document.getElementById('playersList');
            playersListDiv.innerHTML = gameState.players.map(player => `
                <div class="player-item ${player.isCurrentTurn ? 'current-turn' : ''}">
                    <div>
                        <strong>${player.username}</strong>
                        ${player.userId === userId ? ' (You)' : ''}
                    </div>
                    ${player.isReady ? '<span class="ready-badge">Ready</span>' : '<span class="not-ready">Not Ready</span>'}
                </div>
            `).join('');

            // Update ready button
            const myPlayer = gameState.players.find(p => p.userId === userId);
            if (myPlayer) {
                isReady = myPlayer.isReady;
                const readyBtn = document.getElementById('readyBtn');
                if (gameState.status === 'waiting') {
                    readyBtn.textContent = isReady ? 'Not Ready' : 'Ready';
                    readyBtn.disabled = false;
                } else {
                    readyBtn.disabled = true;
                }
            }

            // Update current turn info
            const currentTurnDiv = document.getElementById('currentTurn');
            if (gameState.status === 'in_progress') {
                const currentPlayer = gameState.players.find(p => p.isCurrentTurn);
                if (currentPlayer) {
                    currentTurnDiv.textContent = `Current turn: ${currentPlayer.username}`;

                    // Enable/disable end turn button
                    const endTurnBtn = document.getElementById('endTurnBtn');
                    endTurnBtn.disabled = currentPlayer.userId !== userId;
                }
            } else {
                currentTurnDiv.textContent = '';
                document.getElementById('endTurnBtn').disabled = true;
            }
        }

        function toggleReady() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            ws.send(JSON.stringify({
                type: 'ready',
                payload: { isReady: !isReady }
            }));
        }

        function endTurn() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            ws.send(JSON.stringify({
                type: 'end_turn',
                payload: {}
            }));
        }

        function addLog(message, type = 'event') {
            const logDiv = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        connectWebSocket();
    </script>
</body>
</html>
